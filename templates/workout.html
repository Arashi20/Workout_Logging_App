{% extends "base.html" %}

{% block title %}Workout - Workout Logger{% endblock %}

{% block content %}
<div class="workout-container">
    <h1>Workout Session</h1>

    {% if not active_session %}
    <div class="session-card">
        <p>No active workout session</p>
        <form method="POST" action="{{ url_for('start_workout') }}">
            <button type="submit" class="btn btn-primary btn-large">Start Workout</button>
        </form>
    </div>
    {% else %}
    <div class="session-info">
        <p><strong>Session Started:</strong> {{ active_session.start_time.strftime('%H:%M') }}</p>
        <p><strong>Duration:</strong> <span id="duration">0</span> minutes</p>
    </div>

    <div class="add-set-card">
        <h2>Add Set</h2>
        <form method="POST" action="{{ url_for('add_set') }}" class="workout-form" id="add-set-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="exercise_search">Exercise</label>
                    <input type="text" id="exercise_search" placeholder="Type to search exercises..." autocomplete="off">
                    <input type="hidden" id="exercise_id" name="exercise_id" required>
                    <div id="exercise_dropdown" class="exercise-dropdown"></div>
                </div>

                <div class="form-group">
                    <label for="set_type">Type</label>
                    <select id="set_type" name="set_type">
                        <option value="working">Working</option>
                        <option value="warmup">Warmup</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="weight">Weight (kg)</label>
                    <input type="number" id="weight" name="weight" step="0.5" min="0">
                </div>

                <div class="form-group">
                    <label for="reps">Reps</label>
                    <input type="number" id="reps" name="reps" min="1" required>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Add Set</button>
        </form>
    </div>

    {% if workout_logs %}
    <div class="workout-logs">
        <h2>Today's Workout</h2>
        <div class="logs-list">
            {% set current_exercise = '' %}
            {% for log in workout_logs %}
                {% if log.exercise.name != current_exercise %}
                    {% set current_exercise = log.exercise.name %}
                    <h3 class="exercise-name">{{ log.exercise.name }}</h3>
                {% endif %}
                <div class="log-item {% if log.set_type == 'warmup' %}warmup{% endif %}">
                    <span class="set-info">Set {{ log.set_number }}</span>
                    <span class="set-details">
                        {% if log.weight %}{{ log.weight }}kg × {% endif %}{{ log.reps }} reps
                    </span>
                    <span class="set-type">{{ log.set_type }}</span>
                    <button type="button" class="btn-delete" data-log-id="{{ log.id }}" data-exercise-name="{{ log.exercise.name }}" data-set-info="{% if log.weight %}{{ log.weight }}kg × {% endif %}{{ log.reps }} reps" aria-label="Delete set">×</button>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="action-buttons">
        <form method="POST" action="{{ url_for('finish_workout') }}" class="finish-form">
            <button type="submit" class="btn btn-success btn-large">Finish Workout</button>
        </form>
        <button type="button" class="btn btn-danger btn-large" id="cancel-button">Cancel Workout</button>
    </div>
    
    <!-- Cancel Workout Modal -->
    <div class="modal-overlay" id="cancel-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cancel Workout?</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this workout? All logged sets will be lost.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="modal-cancel">No, Keep Workout</button>
                <form method="POST" action="{{ url_for('cancel_workout') }}" id="cancel-form" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Yes, Cancel Workout</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Set Modal -->
    <div class="modal-overlay" id="delete-set-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete Set?</h2>
            </div>
            <div class="modal-body">
                <p id="delete-set-message">Are you sure you want to delete this set?</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="delete-modal-cancel">No, Keep Set</button>
                <form method="POST" action="" id="delete-set-form" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Yes, Delete Set</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    {% if active_session %}
    const startTime = new Date('{{ active_session.start_time.isoformat() }}Z');
    
    function updateDuration() {
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000 / 60);
        document.getElementById('duration').textContent = diff;
    }
    
    updateDuration();
    setInterval(updateDuration, 60000);
    
    // Custom modal for cancelling workout
    const cancelButton = document.getElementById('cancel-button');
    const cancelModal = document.getElementById('cancel-modal');
    const modalCancel = document.getElementById('modal-cancel');
    
    if (cancelButton && cancelModal && modalCancel) {
        cancelButton.addEventListener('click', function() {
            cancelModal.classList.add('active');
        });
        
        modalCancel.addEventListener('click', function() {
            cancelModal.classList.remove('active');
        });
        
        // Close modal when clicking outside
        cancelModal.addEventListener('click', function(e) {
            if (e.target === cancelModal) {
                cancelModal.classList.remove('active');
            }
        });
    }
    
    // Custom modal for deleting sets
    const deleteSetModal = document.getElementById('delete-set-modal');
    const deleteSetForm = document.getElementById('delete-set-form');
    const deleteModalCancel = document.getElementById('delete-modal-cancel');
    const deleteSetMessage = document.getElementById('delete-set-message');
    const deleteButtons = document.querySelectorAll('.btn-delete');
    
    if (deleteSetModal && deleteSetForm && deleteModalCancel) {
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const logId = this.getAttribute('data-log-id');
                const exerciseName = this.getAttribute('data-exercise-name');
                const setInfo = this.getAttribute('data-set-info');
                
                // Update the modal message with exercise details (safely using DOM methods to avoid XSS)
                deleteSetMessage.textContent = '';
                const fragment = document.createDocumentFragment();
                fragment.appendChild(document.createTextNode('Are you sure you want to delete this set?'));
                fragment.appendChild(document.createElement('br'));
                const strong = document.createElement('strong');
                strong.textContent = exerciseName;
                fragment.appendChild(strong);
                fragment.appendChild(document.createTextNode(' - ' + setInfo));
                deleteSetMessage.appendChild(fragment);
                
                // Update the form action - Flask URL pattern is generated server-side
                deleteSetForm.action = '{{ url_for("delete_set", log_id="__LOG_ID__") }}'.replace('__LOG_ID__', logId);
                
                // Show the modal
                deleteSetModal.classList.add('active');
            });
        });
        
        deleteModalCancel.addEventListener('click', function() {
            deleteSetModal.classList.remove('active');
        });
        
        // Close modal when clicking outside
        deleteSetModal.addEventListener('click', function(e) {
            if (e.target === deleteSetModal) {
                deleteSetModal.classList.remove('active');
            }
        });
    }
    
    // Searchable exercise dropdown
    const exercises = {{ exercises|tojson }};
    
    const exerciseSearch = document.getElementById('exercise_search');
    const exerciseId = document.getElementById('exercise_id');
    const exerciseDropdown = document.getElementById('exercise_dropdown');
    
    let selectedIndex = -1;
    
    function filterExercises(searchTerm) {
        return exercises.filter(ex => 
            ex.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }
    
    function renderDropdown(filteredExercises) {
        exerciseDropdown.innerHTML = '';
        
        if (filteredExercises.length === 0) {
            exerciseDropdown.innerHTML = '<div class="dropdown-message">No exercises found</div>';
            exerciseDropdown.classList.add('active');
            return;
        }
        
        filteredExercises.forEach((exercise, index) => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = exercise.name;
            item.dataset.id = exercise.id;
            item.dataset.index = index;
            
            item.addEventListener('click', function() {
                selectExercise(exercise);
            });
            
            exerciseDropdown.appendChild(item);
        });
        
        exerciseDropdown.classList.add('active');
        selectedIndex = -1;
    }
    
    function selectExercise(exercise) {
        exerciseSearch.value = exercise.name;
        exerciseId.value = exercise.id;
        exerciseDropdown.classList.remove('active');
        selectedIndex = -1;
    }
    
    exerciseSearch.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        exerciseId.value = '';
        
        if (searchTerm.length === 0) {
            exerciseDropdown.classList.remove('active');
            return;
        }
        
        const filtered = filterExercises(searchTerm);
        renderDropdown(filtered);
    });
    
    exerciseSearch.addEventListener('focus', function() {
        const searchTerm = this.value.trim();
        if (searchTerm.length > 0) {
            const filtered = filterExercises(searchTerm);
            renderDropdown(filtered);
        }
    });
    
    exerciseSearch.addEventListener('keydown', function(e) {
        const items = exerciseDropdown.querySelectorAll('.dropdown-item');
        
        if (items.length === 0) return;
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                const id = items[selectedIndex].dataset.id;
                const name = items[selectedIndex].textContent;
                selectExercise({ id, name });
            }
        } else if (e.key === 'Escape') {
            exerciseDropdown.classList.remove('active');
            selectedIndex = -1;
        }
    });
    
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!exerciseSearch.contains(e.target) && !exerciseDropdown.contains(e.target)) {
            exerciseDropdown.classList.remove('active');
            selectedIndex = -1;
        }
    });
    
    // Form validation to ensure an exercise is selected
    const addSetForm = document.getElementById('add-set-form');
    if (addSetForm) {
        addSetForm.addEventListener('submit', function(e) {
            if (!exerciseId.value) {
                e.preventDefault();
                alert('Please select an exercise from the dropdown');
                exerciseSearch.focus();
                return false;
            }
        });
    }
    {% endif %}
</script>
{% endblock %}
